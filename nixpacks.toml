# Nixpacks Build Configuration for Railway
# Spring Boot 3.2.0 Application

[phases.setup]
nixPkgs = ["maven", "jdk17_headless"]
aptPkgs = ["curl"]

[phases.install]
cmds = [
  "echo '=== Environment Info ==='",
  "java -version",
  "mvn -version",
  "echo '========================'"
]

[phases.build]
cmds = [
  "echo '=== Starting Maven Build ==='",
  "mvn clean package -DskipTests -B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn",
  "echo '=== Build Complete ==='",
  "ls -lh target/martinis.jar"
]

[start]
cmd = "java -Dserver.port=$PORT -Dspring.profiles.active=railway -Xmx768m -Xms256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=80.0 -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Djava.security.egd=file:/dev/./urandom -jar target/martinis.jar"

[variables]
# Maven build options
MAVEN_OPTS = "-Xmx1536m -Xms512m -XX:+UseG1GC"

# Java runtime options for Railway deployment
JAVA_TOOL_OPTIONS = "-XX:+UnlockExperimentalVMOptions -Djdk.attach.allowAttachSelf=true"

# Spring Boot configuration
SPRING_OUTPUT_ANSI_ENABLED = "ALWAYS"
